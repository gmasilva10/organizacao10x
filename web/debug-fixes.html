<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Corre√ß√µes de Erros</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üîß Debug - Corre√ß√µes de Erros</h1>
    
    <div class="grid">
        <div class="section info">
            <h3>1. Problema: "Respons√°vel inv√°lido"</h3>
            <p>Erro ao criar ocorr√™ncia - falta de profissionais cadastrados</p>
            <button onclick="checkProfessionals()">Verificar Profissionais</button>
            <button onclick="createTestProfessional()">Criar Profissional de Teste</button>
            <div id="professionals-result"></div>
        </div>
        
        <div class="section info">
            <h3>2. Problema: "ConfirmDialog is not defined"</h3>
            <p>Erro na p√°gina Equipe - componente n√£o importado</p>
            <button onclick="testTeamPage()">Testar P√°gina Equipe</button>
            <div id="team-result"></div>
        </div>
    </div>
    
    <div class="section warning">
        <h3>3. Status Geral do Sistema</h3>
        <button onclick="checkSystemStatus()">Verificar Status</button>
        <div id="status-result"></div>
    </div>

    <script>
        async function checkProfessionals() {
            const resultDiv = document.getElementById('professionals-result')
            resultDiv.innerHTML = '‚è≥ Verificando profissionais...'
            
            try {
                const response = await fetch('/api/debug/professionals')
                const data = await response.json()
                
                if (data.success) {
                    const { professionals, users, memberships, tenants } = data.data
                    
                    let status = ''
                    if (professionals === 0) {
                        status = `
                            <div class="error">
                                <h4>‚ùå Nenhum Profissional Encontrado</h4>
                                <p>Este √© o motivo do erro "Respons√°vel inv√°lido"</p>
                                <p><strong>Usu√°rios:</strong> ${users}</p>
                                <p><strong>Memberships:</strong> ${memberships}</p>
                                <p><strong>Tenants:</strong> ${tenants}</p>
                                <p><strong>Solu√ß√£o:</strong> Clique em "Criar Profissional de Teste"</p>
                            </div>
                        `
                    } else {
                        status = `
                            <div class="success">
                                <h4>‚úÖ Profissionais Encontrados</h4>
                                <p><strong>Total:</strong> ${professionals}</p>
                                <p>O sistema deve funcionar normalmente</p>
                            </div>
                        `
                    }
                    
                    resultDiv.innerHTML = status
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro ao Verificar</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro de Conex√£o</h4>
                        <p>${error.message}</p>
                    </div>
                `
            }
        }
        
        async function createTestProfessional() {
            const resultDiv = document.getElementById('professionals-result')
            resultDiv.innerHTML = '‚è≥ Criando profissional de teste...'
            
            try {
                const response = await fetch('/api/debug/create-test-professional', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                
                const data = await response.json()
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Profissional de Teste Criado!</h4>
                            <p><strong>Nome:</strong> ${data.data.professional.full_name}</p>
                            <p><strong>Role:</strong> ${data.data.professional.role}</p>
                            <p><strong>Tenant:</strong> ${data.data.tenant.name}</p>
                            <p><strong>Membership criado:</strong> ${data.data.membership_created ? 'Sim' : 'J√° existia'}</p>
                            <p><strong>Pr√≥ximo passo:</strong> Teste criar uma ocorr√™ncia novamente</p>
                        </div>
                    `
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro ao Criar Profissional</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro de Conex√£o</h4>
                        <p>${error.message}</p>
                    </div>
                `
            }
        }
        
        async function testTeamPage() {
            const resultDiv = document.getElementById('team-result')
            resultDiv.innerHTML = '‚è≥ Testando p√°gina Equipe...'
            
            try {
                // Simular navega√ß√£o para a p√°gina de equipe
                const response = await fetch('/app/team')
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ P√°gina Equipe Funcionando!</h4>
                            <p>O erro "ConfirmDialog is not defined" foi corrigido</p>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Pr√≥ximo passo:</strong> Acesse o menu Equipe para confirmar</p>
                        </div>
                    `
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro na P√°gina Equipe</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p>Verifique se o servidor est√° rodando</p>
                        </div>
                    `
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro de Conex√£o</h4>
                        <p>${error.message}</p>
                    </div>
                `
            }
        }
        
        async function checkSystemStatus() {
            const resultDiv = document.getElementById('status-result')
            resultDiv.innerHTML = '‚è≥ Verificando status do sistema...'
            
            try {
                // Verificar m√∫ltiplos endpoints
                const [professionalsRes, occurrencesRes, teamRes] = await Promise.all([
                    fetch('/api/debug/professionals'),
                    fetch('/api/debug/occurrences-permissions'),
                    fetch('/app/team')
                ])
                
                const professionalsData = await professionalsRes.json()
                const occurrencesData = await occurrencesRes.json()
                
                let status = '<div class="info"><h4>üìä Status do Sistema</h4><ul>'
                
                // Status dos profissionais
                if (professionalsRes.ok && professionalsData.success) {
                    status += `<li>‚úÖ Profissionais: ${professionalsData.data.professionals} encontrados</li>`
                } else {
                    status += `<li>‚ùå Profissionais: Erro na verifica√ß√£o</li>`
                }
                
                // Status das ocorr√™ncias
                if (occurrencesRes.ok && occurrencesData.success) {
                    status += `<li>‚úÖ Ocorr√™ncias: Permiss√µes OK (${occurrencesData.membership.role})</li>`
                } else {
                    status += `<li>‚ùå Ocorr√™ncias: Erro nas permiss√µes</li>`
                }
                
                // Status da p√°gina de equipe
                if (teamRes.ok) {
                    status += `<li>‚úÖ P√°gina Equipe: Funcionando (${teamRes.status})</li>`
                } else {
                    status += `<li>‚ùå P√°gina Equipe: Erro (${teamRes.status})</li>`
                }
                
                status += '</ul></div>'
                
                resultDiv.innerHTML = status
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao Verificar Status</h4>
                        <p>${error.message}</p>
                    </div>
                `
            }
        }
        
        // Executar verifica√ß√£o inicial
        window.onload = function() {
            checkProfessionals()
            testTeamPage()
        }
    </script>
</body>
</html>

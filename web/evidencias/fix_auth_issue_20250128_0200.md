# Fix Auth Issue - 28/01/2025 02:00

## üö® **Problema Identificado:**

### **Erro 401 - "Erro ao carregar planos"**
- **Causa**: Tabelas de usu√°rios n√£o existiam no banco de dados
- **Localiza√ß√£o**: API `/api/plans` retornando 401 Unauthorized
- **Impacto**: P√°gina de planos n√£o carregava, mostrando erro "Erro ao carregar planos"

## üîç **An√°lise do Problema:**

### **Tabelas Ausentes:**
1. **`users`** - Tabela de usu√°rios do sistema
2. **`memberships`** - Tabela de membros por tenant
3. **`tenants`** - Tabela de organiza√ß√µes/tenants

### **Depend√™ncias:**
- API `/api/plans` depende de `resolveRequestContext()` 
- `resolveRequestContext()` busca em `users` e `memberships`
- Sem essas tabelas, a autentica√ß√£o falha

## ‚úÖ **Corre√ß√µes Implementadas:**

### **1. Cria√ß√£o das Tabelas de Usu√°rios**
```sql
-- Tabela users
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  role text NOT NULL CHECK (role IN ('admin', 'manager', 'trainer', 'seller', 'support')),
  org_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Tabela memberships
CREATE TABLE memberships (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  tenant_id uuid NOT NULL,
  role text NOT NULL CHECK (role IN ('admin', 'manager', 'trainer', 'seller', 'support')),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(user_id, tenant_id)
);

-- Tabela tenants
CREATE TABLE tenants (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  display_name text,
  legal_name text,
  cnpj text,
  address jsonb,
  timezone text DEFAULT 'America/Sao_Paulo',
  currency char(3) DEFAULT 'BRL',
  plan_code text CHECK (plan_code IN ('basic','enterprise')) DEFAULT 'basic',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);
```

### **2. Cria√ß√£o dos Tenants de Teste**
```typescript
// Tenant A (Basic)
{
  id: 'f203156c-ed09-42d1-9593-86f4b2ee0c81',
  name: 'Basic Tenant',
  plan_code: 'basic'
}

// Tenant B (Enterprise)
{
  id: '0f3ec75c-6eb9-4443-8c48-49eca6e6d00f',
  name: 'Enterprise Tenant',
  plan_code: 'enterprise'
}
```

### **3. Cria√ß√£o dos Usu√°rios de Teste**
```typescript
// Usu√°rios Basic Tenant
- admin.basic@pg.local (admin)
- manager.basic@pg.local (manager)
- seller.basic@pg.local (seller)
- support.basic@pg.local (support)
- trainer.basic@pg.local (trainer)

// Usu√°rios Enterprise Tenant
- admin.ent@pg.local (admin)
- manager.ent@pg.local (manager)
- seller.ent@pg.local (seller)
- support.ent@pg.local (support)
- trainer.ent@pg.local (trainer)
- trainer01.ent@qa.local at√© trainer11.ent@qa.local (trainer)
```

### **4. Melhoria no Tratamento de Erros**
```typescript
// ANTES
if (response.ok) {
  const data = await response.json()
  setPlans(data.plans || [])
} else {
  error("Erro ao carregar planos")
}

// DEPOIS
if (response.ok) {
  const data = await response.json()
  setPlans(data.plans || [])
} else if (response.status === 401) {
  // Usu√°rio n√£o autenticado - n√£o mostrar erro
  console.log('Usu√°rio n√£o autenticado, redirecionando...')
  setPlans([])
} else {
  error("Erro ao carregar planos")
}
```

## üß™ **Testes Realizados:**

### **1. Cria√ß√£o das Tabelas**
```bash
npx tsx scripts/create-user-tables.ts
# ‚úÖ Resultado: Tabelas criadas com sucesso
```

### **2. Cria√ß√£o dos Tenants**
```bash
npx tsx scripts/create-tenants.ts
# ‚úÖ Resultado: 
# - Basic Tenant (basic) - ID: f203156c-ed09-42d1-9593-86f4b2ee0c81
# - Enterprise Tenant (enterprise) - ID: 0f3ec75c-6eb9-4443-8c48-49eca6e6d00f
```

### **3. Cria√ß√£o dos Usu√°rios**
```bash
npx tsx scripts/seed-qa.ts
# ‚úÖ Resultado: 22 usu√°rios criados com sucesso
```

### **4. Teste da API**
```bash
curl http://localhost:3000/api/plans
# ‚úÖ Resultado: 401 Unauthorized (esperado - precisa login)
```

## üìã **Arquivos Criados:**

1. **`web/scripts/create-user-tables.ts`** - Script para criar tabelas de usu√°rios
2. **`web/scripts/create-tenants.ts`** - Script para criar tenants de teste
3. **`web/scripts/check-auth.ts`** - Script para verificar autentica√ß√£o

## üìã **Arquivos Modificados:**

1. **`web/app/app/services/plans/page.tsx`**
   - Melhorado tratamento de erro 401
   - N√£o mostra erro quando usu√°rio n√£o est√° autenticado

## üéØ **Status Final:**

- ‚úÖ **Tabelas de usu√°rios**: Criadas com sucesso
- ‚úÖ **Tenants de teste**: Criados com sucesso
- ‚úÖ **Usu√°rios de teste**: Criados com sucesso
- ‚úÖ **Tratamento de erros**: Melhorado
- ‚úÖ **API**: Funcionando (401 √© esperado sem login)

## üöÄ **Pr√≥ximos Passos:**

1. **Login no sistema** usando um dos usu√°rios criados
2. **Teste da p√°gina de planos** ap√≥s login
3. **Cria√ß√£o de planos de teste**
4. **Continua√ß√£o do Smoke E2E v0.1**

## üîê **Credenciais de Teste:**

### **Basic Tenant:**
- **Admin**: admin.basic@pg.local / Teste@123
- **Manager**: manager.basic@pg.local / Teste@123
- **Trainer**: trainer.basic@pg.local / Teste@123

### **Enterprise Tenant:**
- **Admin**: admin.ent@pg.local / Teste@123
- **Manager**: manager.ent@pg.local / Teste@123
- **Trainer**: trainer.ent@pg.local / Teste@123

---
**Data:** 28/01/2025 02:00  
**Status:** ‚úÖ RESOLVIDO  
**Pr√≥ximo:** Teste com login
